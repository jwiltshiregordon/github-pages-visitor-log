<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>GitHub Pages Visitor Log</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Arial', sans-serif;
        }

        .container {
            margin-top: 50px;
        }

        .content-area {
            background-color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .output-box {
            background-color: mintcream;
            display: none;
            margin: 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            background-color: #eaf3ff;
            padding: 10px;
            border-radius: 5px;
        }

        .btn-primary, .btn-secondary {
            width: 250px;
            margin: 20px;
        }

        #repoOwner, #repoName {
            border: 1px solid #007bff;
            margin-left: 10px;
            margin-right: 10px;
        }

        .list-group-item {
            font-size: 16px;
            margin-top: 10px;
        }

        p {
            font-size: 16px;
        }

    </style>
    <script>

        function formatLogsForDisplay(logs) {
            let formattedLogs = [];
            logs.forEach(log => {
                let details = log.event_details.split('\n').join('\t');
                let timeAgo = moment.utc(log.timestamp).fromNow();
                formattedLogs.push(`${log.repo_name}\t${timeAgo}\t${details}`);
            });
            return formattedLogs.join('\n');
        }


        async function handleButtonClick(action) {
            const repoOwner = document.getElementById('repoOwner').value;
            const repoName = document.getElementById('repoName').value;
            const outputBox = document.getElementById('output-box');
            const outputCode = document.getElementById('output-code');
            const apiUrlBase = 'https://api.github-pages-visitor-log.net';

            document.getElementById('output-code').textContent = "loading...";

            switch(action) {
                case 'update':
                    fetch(apiUrlBase + '/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            repo_owner: repoOwner,
                            repo_name: repoName
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        outputCode.textContent = JSON.stringify(data, null, 2);
                    });
                    break;

                case 'view':
                    fetch(apiUrlBase + '/fetch-logs?repo_owner=' + repoOwner + '&repo_name=' + repoName)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('output-code').textContent = formatLogsForDisplay(data.logs);
                    });
                    break;

              case 'show':
                  const scriptTag = "script";
                  let scriptBody = await (await fetch('./snippets/client.js')).text();
                  scriptBody = scriptBody.replace("REPO_OWNER", repoOwner);
                  scriptBody = scriptBody.replace("REPO_NAME", repoName);
                  const scriptContent = `<${scriptTag}>${scriptBody}<\/${scriptTag}>`
                  document.getElementById('output-code').textContent = scriptContent;
                  break;
            }
            outputBox.style.display = "block";
        }
    </script>
</head>

<body>
    <div class="container">
        <div class="content-area">
            <h1>GitHub Pages Visitor Log</h1>
            <h4>A free, open source alternative to Google Analytics for GitHub Pages</h4>
        </div>

        <div class="content-area">
            <h3>Log info about page views and interactions</h3>
            <p class="">
              This project helps record visitor information on GitHub Pages sites. Participation is free.
              Google Analytics is another free option, but then the user data is sent to Google for unknown, and presumably
              monetizable, purposes.
              This project is a little different. You generate messages using js on the page, and then
              post them to <code>api.github-pages-visitor-log.net/log</code> where they become viewable by the
              public. This way you can tell if/how people are using your site, and it's totally above-board
              what you're doing and who can see it.
            </p>
            <p class="">
                Currently, only the last 100 messages are retained for any participating repository.
            </p>

        </div>


        <div class="content-area">
            <h3>Get started</h3>
            <ol class="">
                <li class="list-group-item">1. A public github repository signals participation by placing a sentinel file <code>.github-pages-visitor-log</code>
                at the repository root. Select "Update Registration"</li>
                <li class="list-group-item">2. The logs of any registered repo are public. Select "View Logs"</li>
                <li class="list-group-item">3. Send messages from your site using javascript. To see the script tag you'll need to add to your html, select "Show Script"</li>
            </ol>
            <form id="apiForm">
                <div class="form-group bg-light p-3 rounded" style="width: fit-content; margin: auto;">
                    <div class="d-flex align-items-center lead" style="width: 900px">
                        <label for="repoOwner" class="mb-0">https://github.com/</label>
                        <input type="text" class="form-control" id="repoOwner" name="owner" placeholder="owner" style="width: 250px;">
                        <span>/</span>
                        <input type="text" class="form-control" id="repoName" name="repository" placeholder="repository" style="width: 250px;">
                    </div>
                    <div class="form-group bg-light rounded d-flex mt-3" style="justify-content: space-between">
                        <button type="button" class="btn btn-primary" onclick="handleButtonClick('update')">Update Registration</button>
                        <button type="button" class="btn btn-primary" onclick="handleButtonClick('view')">View Logs</button>
                        <button type="button" class="btn btn-primary" onclick="handleButtonClick('show')">Show Script</button>
                    </div>
                </div>
            </form>
        </div>

        <div id="output-box" class="output-box mt-4 card">
            <div class="card-header">
                Output
            </div>
            <div class="card-body">
                <pre><code id="output-code">
                </code></pre>
            </div>
        </div>

    </div>
</body>

</html>
